<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pandoc • Local UI</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#f5f5f7; --card:#fff; --txt:#1d1d1f; --muted:#6e6e73; --accent:#0071e3;
    --border:#e5e5ea; --shadow:0 6px 18px rgba(0,0,0,.06), 0 2px 8px rgba(0,0,0,.04);
    --radius:18px;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0b0b0c; --card:#151516; --txt:#f5f5f7; --muted:#a1a1a6; --border:#2c2c2e; --accent:#0a84ff;
           --shadow:0 8px 24px rgba(0,0,0,.5), 0 2px 8px rgba(0,0,0,.35); }
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--txt);
       font:16px/1.55 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;}
  .wrap{max-width:980px; margin:48px auto; padding:0 20px;}
  .hero{text-align:center; margin-bottom:28px;}
  .badge{display:inline-block; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted);
         font-size:12px; margin-bottom:10px; background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,0));
         backdrop-filter:saturate(180%) blur(20px);}
  h1{font-weight:700; font-size:28px; margin:6px 0 8px; letter-spacing:-.01em;}
  p.lead{color:var(--muted); margin:0}
  .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
        padding:22px; margin-bottom:18px;}
  .grid{display:grid; gap:14px}
  @media(min-width:780px){ .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:1fr 1fr 1fr} }
  label.title{display:block; font-weight:600; margin:4px 0 6px}
  input[type="file"],input[type="text"],input[type="url"],select,textarea,button{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
    background:transparent; color:var(--txt);
  }
  textarea{min-height:140px; resize:vertical}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
  .btn{border:1px solid transparent; cursor:pointer; font-weight:600; transition:transform .03s ease}
  .btn.primary{background:var(--accent); color:#fff}
  .btn.ghost{background:transparent; border-color:var(--border); color:var(--txt)}
  .btn:active{transform:translateY(1px)}
  .footer{color:var(--muted); text-align:center; margin-top:14px; font-size:13px}
  .log{white-space:pre-wrap; background:transparent; border:1px dashed var(--border); padding:10px; border-radius:12px; min-height:64px}
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="badge">Local conversion • Pandoc</div>
    <h1>Pandoc UI locale</h1>
    <p class="lead">Converti documenti tra formati comuni. Tutto rimane in locale nel container.</p>
  </div>

  <div class="card grid two">
    <div>
      <label class="title">Sorgente (carica un file)…</label>
      <input type="file" id="file"/>
      <div class="row" style="margin-top:8px">
        <span class="chip">markdown / docx / odt / html / rst / tex …</span>
      </div>
    </div>
    <div>
      <label class="title">…oppure incolla testo (Markdown/HTML)</label>
      <textarea id="text" placeholder="## Titolo\n\nTesto…"></textarea>
    </div>
  </div>

  <div class="card grid three">
    <div>
      <label class="title">Formato input</label>
      <select id="from">
        <option value="">Auto (consigliato)</option>
        <option>markdown</option>
        <option>html</option>
        <option>docx</option>
        <option>odt</option>
        <option>rst</option>
        <option>latex</option>
      </select>
    </div>
    <div>
      <label class="title">Formato output</label>
      <select id="to">
        <option>pdf</option>
        <option selected>docx</option>
        <option>odt</option>
        <option>html</option>
        <option>md</option>
        <option>rst</option>
        <option>pptx</option>
        <option>epub</option>
      </select>
    </div>
    <div>
      <label class="title">Nome file di output</label>
      <input type="text" id="outname" placeholder="output.ext"/>
    </div>
  </div>

  <div class="card grid two">
    <div>
      <label class="title">Metadati</label>
      <input type="text" id="title" placeholder="Titolo"/>
      <input type="text" id="author" placeholder="Autore" style="margin-top:8px"/>
      <div class="row" style="margin-top:10px">
        <label class="chip"><input type="checkbox" id="toc"> TOC</label>
        <label class="chip"><input type="checkbox" id="number_sections"> Number sections</label>
        <label class="chip"><input type="checkbox" id="citeproc"> Citeproc</label>
      </div>
    </div>
    <div>
      <label class="title">Template / Stili</label>
      <input type="file" id="template" title="Pandoc template (es. .tex, .html)"/>
      <input type="file" id="csl" style="margin-top:8px" title="CSL (stile bibliografico, .csl)"/>
      <input type="file" id="reference_doc" style="margin-top:8px" title="Reference docx/odt"/>
      <input type="file" id="resources" style="margin-top:8px" title="resources.zip (immagini, css, ecc.)"/>
    </div>
  </div>

  <div class="card grid two">
    <div>
      <label class="title">Preset</label>
      <select id="preset">
        <option value="">— Nessun preset —</option>
        <option value="pdf_manuscript">Manuscript PDF (XeLaTeX)</option>
        <option value="beamer">Slide PDF (Beamer)</option>
        <option value="revealjs">Slide HTML (Reveal.js)</option>
        <option value="docx_manuscript">Manuscript DOCX</option>
        <option value="epub">eBook EPUB</option>
        <option value="odt_report">Report ODT</option>
      </select>
    </div>
    <div class="row" style="align-items:flex-end; justify-content:flex-end">
      <button class="btn ghost" id="applyPreset">Applica preset</button>
    </div>
  </div>

  <div class="card">
    <label class="title">Argomenti avanzati Pandoc (opzionali)</label>
    <input type="text" id="extra_args" placeholder="es. --css stile.css --resource-path=.:assets"/>
  </div>

  <div class="card">
    <div class="row" style="justify-content:flex-end">
      <button class="btn ghost" id="reset">Reset</button>
      <button class="btn primary" id="run">Converti e scarica</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center">
      <strong>Log</strong>
      <small class="muted"><a href="#" id="clearLog">pulisci</a></small>
    </div>
    <div class="log" id="log"></div>
  </div>

  <div class="footer">Pandoc via Flask · UI locale</div>
</div>

<script>
const $ = id => document.getElementById(id);
const log = (t) => { const el = $("log"); el.textContent = t + "\n" + el.textContent; };

$("clearLog").addEventListener("click",(e)=>{ e.preventDefault(); $("log").textContent=""; });

$("reset").addEventListener("click",(e)=>{
  e.preventDefault();
  $("file").value = ""; $("text").value = "";
  $("from").value = ""; $("to").value = "docx";
  $("outname").value = ""; $("title").value = ""; $("author").value = "";
  $("toc").checked = false; $("number_sections").checked = false; $("citeproc").checked = false;
  $("template").value = ""; $("csl").value = ""; $("reference_doc").value = ""; $("resources").value = "";
  $("extra_args").value = ""; $("preset").value = "";
  $("log").textContent="";
});

const presets = {
  pdf_manuscript: {
    to: "pdf",
    from: "",
    extra: "--pdf-engine=xelatex -V geometry:margin=2.5cm -V linkcolor=blue --toc --number-sections --citeproc"
  },
  beamer: {
    to: "pdf",
    from: "markdown",
    extra: "-t beamer --pdf-engine=xelatex -V theme=metropolis -V fontsize=11pt --citeproc"
  },
  revealjs: {
    to: "html",
    from: "markdown",
    // Richiede internet per CDN; in alternativa carica reveal localmente via resources.zip e usa --standalone -V revealjs-url=./reveal
    extra: "-t revealjs -s -V revealjs-url=https://unpkg.com/reveal.js@5/"
  },
  docx_manuscript: {
    to: "docx",
    from: "",
    extra: "--toc --number-sections --citeproc"
  },
  epub: {
    to: "epub",
    from: "",
    extra: "--toc --number-sections --citeproc"
  },
  odt_report: {
    to: "odt",
    from: "",
    extra: "--toc --number-sections"
  }
};

$("applyPreset").addEventListener("click", ()=>{
  const key = $("preset").value;
  if(!key) return;
  const p = presets[key];
  $("to").value = p.to;
  $("from").value = p.from;
  $("extra_args").value = p.extra;
  // Suggerimenti su metadati
  if (!$("title").value) $("title").value = "Titolo";
  if (!$("author").value) $("author").value = "Autore";
  // Flag coerenti con preset
  $("toc").checked = /\b--toc\b/.test(p.extra);
  $("number_sections").checked = /\b--number-sections\b/.test(p.extra);
  $("citeproc").checked = /\b--citeproc\b/.test(p.extra);
  log("Preset applicato: " + key);
});

$("run").addEventListener("click", async ()=>{
  const fd = new FormData();
  const f = $("file").files[0];
  const text = $("text").value.trim();

  if (!f && !text) return alert("Carica un file oppure incolla del testo.");

  if (f) fd.append("file", f, f.name);
  if (text) fd.append("text", text);

  const from = $("from").value.trim();
  const to = $("to").value.trim();
  if (!to) return alert("Seleziona un formato di output.");

  fd.append("from", from);
  fd.append("to", to);

  const out = $("outname").value.trim();
  if (out) fd.append("outname", out);

  const title = $("title").value.trim();
  const author = $("author").value.trim();
  if (title) fd.append("title", title);
  if (author) fd.append("author", author);

  if ($("toc").checked) fd.append("toc", "on");
  if ($("number_sections").checked) fd.append("number_sections", "on");
  if ($("citeproc").checked) fd.append("citeproc", "on");

  const tpl = $("template").files[0];
  if (tpl) fd.append("template", tpl, tpl.name);

  const csl = $("csl").files[0];
  if (csl) fd.append("csl", csl, csl.name);

  const refdoc = $("reference_doc").files[0];
  if (refdoc) fd.append("reference_doc", refdoc, refdoc.name);

  const resources = $("resources").files[0];
  if (resources) fd.append("resources", resources, resources.name);

  const extra = $("extra_args").value.trim();
  if (extra) fd.append("extra_args", extra);

  try{
    log("Invio richiesta a /api/convert …");
    const res = await fetch("/api/convert", { method:"POST", body: fd });
    if (!res.ok) {
      const data = await res.json().catch(()=>({}));
      log("ERRORE " + res.status + ": " + (data.error || "errore"));
      if (data.log) log(data.log);
      if (data.cmd) log("CMD: " + JSON.stringify(data.cmd));
      return alert("Conversione fallita. Vedi log.");
    }
    const blob = await res.blob();
    const hdr = res.headers.get("Content-Disposition") || "";
    const m = /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(hdr);
    const filename = (m && (decodeURIComponent(m[1] || m[2]))) || ("output."+to);
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    log("OK: scaricato " + filename);
  }catch(err){
    console.error(err); log("Eccezione: " + err.message); alert("Errore. Vedi log.");
  }
});
</script>
</body>
</html>